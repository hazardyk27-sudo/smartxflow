<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartXFlow Admin - Alarm Yapilandirma</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: #58a6ff;
            font-size: 24px;
            font-weight: 600;
        }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #238636;
            color: white;
        }
        .btn-primary:hover {
            background: #2ea043;
        }
        .btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
        }
        .btn-danger {
            background: #da3633;
            color: white;
        }
        .btn-danger:hover {
            background: #f85149;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group:last-child {
            margin-bottom: 0;
        }
        label {
            display: block;
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #30363d;
            border-radius: 24px;
            transition: 0.3s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: #c9d1d9;
            border-radius: 50%;
            transition: 0.3s;
        }
        input:checked + .slider {
            background: #238636;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .switch-label {
            color: #c9d1d9;
            font-size: 14px;
        }
        .row {
            display: flex;
            gap: 12px;
        }
        .row .form-group {
            flex: 1;
        }
        .section-title {
            color: #58a6ff;
            font-size: 13px;
            font-weight: 600;
            margin: 16px 0 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #21262d;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            background: #238636;
            color: white;
        }
        .toast.error {
            background: #da3633;
            color: white;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.enabled {
            background: #238636;
        }
        .status-dot.disabled {
            background: #6e7681;
        }
        .criteria-section {
            background: #0d1117;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }
        .criteria-title {
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        .help-text {
            color: #6e7681;
            font-size: 11px;
            margin-top: 4px;
        }
        .back-link {
            color: #58a6ff;
            text-decoration: none;
            font-size: 14px;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .input-with-switch {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-with-switch input[type="number"] {
            flex: 1;
        }
        .input-with-switch .switch {
            width: 36px;
            height: 20px;
        }
        .input-with-switch .slider:before {
            height: 14px;
            width: 14px;
        }
        .input-with-switch input:checked + .slider:before {
            transform: translateX(16px);
        }
        .card-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-recalc {
            padding: 4px 8px;
            font-size: 11px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #8b949e;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-recalc:hover {
            background: #30363d;
            color: #c9d1d9;
            border-color: #58a6ff;
        }
        .btn-recalc:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-recalc.running {
            background: #1f6feb;
            border-color: #1f6feb;
            color: white;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .recalc-status {
            font-size: 10px;
            color: #8b949e;
            margin-top: 4px;
            padding: 4px 8px;
            background: #0d1117;
            border-radius: 4px;
            display: none;
        }
        .recalc-status.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Alarm Yapilandirma <span id="config-version-badge" style="font-size: 12px; background: #238636; padding: 2px 8px; border-radius: 12px; margin-left: 8px;">v-</span></h1>
                <a href="/" class="back-link">Ana Sayfaya Don</a>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="reloadConfig()">Dosyadan Yukle</button>
                <button class="btn btn-primary" onclick="saveConfig()">Degisiklikleri Kaydet</button>
                <button class="btn btn-danger" onclick="recalculateAlarms()" id="recalc-btn">Tum Alarmlari Yeniden Hesapla</button>
            </div>
        </div>

        <div class="grid">
            <!-- Sharp Money -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="sharp-status"></span>
                        Sharp Money
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-sharp" onclick="recalcAlarmType('sharp')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="sharp-enabled" onchange="updateStatus('sharp')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-sharp"></div>
                <div class="card-body">
                    <div class="section-title">Piyasa Hacim Esikleri</div>
                    <div class="row">
                        <div class="form-group">
                            <label>1X2</label>
                            <input type="number" id="sharp-volume_1x2" step="100">
                        </div>
                        <div class="form-group">
                            <label>O/U 2.5</label>
                            <input type="number" id="sharp-volume_ou25" step="100">
                        </div>
                        <div class="form-group">
                            <label>BTTS</label>
                            <input type="number" id="sharp-volume_btts" step="100">
                        </div>
                    </div>
                    <div class="section-title">Tespit Kriterleri</div>
                    <div class="form-group">
                        <label>Hacim Soku Katsayisi (X)</label>
                        <div class="input-with-switch">
                            <input type="number" id="sharp-volume_shock_multiplier" step="0.1">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="sharp-use_volume_shock">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Hacim bu katsayi kadar artmissa tetiklenir</span>
                    </div>
                    <div class="form-group">
                        <label>Minimum Oran Dususu (%)</label>
                        <div class="input-with-switch">
                            <input type="number" id="sharp-odds_drop_min" step="0.1">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="sharp-use_odds_drop">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Oran bu kadar dusmusse tetiklenir</span>
                    </div>
                    <div class="form-group">
                        <label>Minimum Pay Degisimi (puan)</label>
                        <div class="input-with-switch">
                            <input type="number" id="sharp-share_shift_min" step="0.5">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="sharp-use_share_shift">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Pay degisimi bu kadarsa tetiklenir</span>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Sharp Skor Esigi</label>
                            <input type="number" id="sharp-score_threshold_sharp" step="1">
                        </div>
                        <div class="form-group">
                            <label>Medium Skor Esigi</label>
                            <input type="number" id="sharp-score_threshold_medium" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dropping Alert -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="dropping-status"></span>
                        Dropping Alert
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-dropping" onclick="recalcAlarmType('dropping')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="dropping-enabled" onchange="updateStatus('dropping')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-dropping"></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Minimum Dusus Esigi (%) - Seviye 1</label>
                        <input type="number" id="dropping-drop_threshold" step="0.5">
                        <span class="help-text">Seviye 1 bu esikten baslar</span>
                    </div>
                    <div class="form-group">
                        <label>Seviye 2 Dusus (%)</label>
                        <div class="input-with-switch">
                            <input type="number" id="dropping-level2_drop" step="0.5">
                            <label class="switch" title="Seviye 2 kullan">
                                <input type="checkbox" id="dropping-use_level2">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Bu esik asildiginda Seviye 2 alarmi</span>
                    </div>
                    <div class="form-group">
                        <label>Seviye 3 Dusus (%)</label>
                        <div class="input-with-switch">
                            <input type="number" id="dropping-level3_drop" step="0.5">
                            <label class="switch" title="Seviye 3 kullan">
                                <input type="checkbox" id="dropping-use_level3">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Bu esik asildiginda Seviye 3 alarmi</span>
                    </div>
                    <div class="form-group">
                        <label>Kalicilik Suresi (dakika)</label>
                        <div class="input-with-switch">
                            <input type="number" id="dropping-persistence_minutes" step="5">
                            <label class="switch" title="Kalicilik kontrolu kullan">
                                <input type="checkbox" id="dropping-use_persistence">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Dusus bu sure boyunca devam etmeli</span>
                    </div>
                </div>
            </div>

            <!-- Momentum Spike -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="momentum-status"></span>
                        Momentum Spike
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-momentum" onclick="recalcAlarmType('momentum')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="momentum-enabled" onchange="updateStatus('momentum')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-momentum"></div>
                <div class="card-body">
                    <div class="section-title">Piyasa Hacim Esikleri</div>
                    <div class="row">
                        <div class="form-group">
                            <label>1X2</label>
                            <input type="number" id="momentum-volume_1x2" step="100">
                        </div>
                        <div class="form-group">
                            <label>O/U 2.5</label>
                            <input type="number" id="momentum-volume_ou25" step="50">
                        </div>
                        <div class="form-group">
                            <label>BTTS</label>
                            <input type="number" id="momentum-volume_btts" step="50">
                        </div>
                    </div>
                    <div class="section-title">Kriter Esikleri</div>
                    <div class="form-group">
                        <label>Minimum Anlik Pay (%)</label>
                        <input type="number" id="momentum-share_now_min" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Minimum Pay Degisimi (%)</label>
                        <input type="number" id="momentum-percentage_change_min" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Minimum Oran Dususu (%)</label>
                        <input type="number" id="momentum-odds_drop_min" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Minimum Kriter Sayisi</label>
                        <input type="number" id="momentum-min_criteria_to_trigger" min="1" max="4" step="1">
                        <span class="help-text">Alarm icin kac kriterin saglanmasi gerekir</span>
                    </div>
                    <div class="criteria-section">
                        <div class="criteria-title">Aktif Kriterler (kontrol edilecekler)</div>
                        <div class="switch-container" style="margin-bottom: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="momentum-use_new_money">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Yeni Para (hacim esigi)</span>
                        </div>
                        <div class="switch-container" style="margin-bottom: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="momentum-use_share_now">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Anlik Pay kriteri</span>
                        </div>
                        <div class="switch-container" style="margin-bottom: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="momentum-use_percentage_change">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Pay Degisimi kriteri</span>
                        </div>
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="momentum-use_odds_drop">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Oran Dususu kriteri</span>
                        </div>
                    </div>
                    <div class="section-title">Seviye Esikleri (Yeni Para)</div>
                    <div class="row">
                        <div class="form-group">
                            <label>S1 Min</label>
                            <input type="number" id="momentum-level1_money" step="100">
                        </div>
                        <div class="form-group">
                            <label>S2 Min</label>
                            <input type="number" id="momentum-level2_money" step="100">
                        </div>
                        <div class="form-group">
                            <label>S3 Min</label>
                            <input type="number" id="momentum-level3_money" step="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Line Freeze -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="line_freeze-status"></span>
                        Line Freeze
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-line_freeze" onclick="recalcAlarmType('line_freeze')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="line_freeze-enabled" onchange="updateStatus('line_freeze')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-line_freeze"></div>
                <div class="card-body">
                    <div class="section-title">Sure Esikleri (dakika)</div>
                    <div class="row">
                        <div class="form-group">
                            <label>Min Donma</label>
                            <input type="number" id="line_freeze-min_freeze_duration" step="5">
                        </div>
                        <div class="form-group">
                            <label>S2 Sure</label>
                            <input type="number" id="line_freeze-level2_duration" step="5">
                        </div>
                        <div class="form-group">
                            <label>S3 Sure</label>
                            <input type="number" id="line_freeze-level3_duration" step="5">
                        </div>
                    </div>
                    <div class="section-title">Para Esikleri</div>
                    <div class="criteria-section">
                        <div class="switch-container" style="margin-bottom: 12px;">
                            <label class="switch">
                                <input type="checkbox" id="line_freeze-use_money_thresholds">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Para esiklerini kullan</span>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>S1 Min Para</label>
                                <input type="number" id="line_freeze-l1_min_money" step="100">
                            </div>
                            <div class="form-group">
                                <label>S2 Min Para</label>
                                <input type="number" id="line_freeze-l2_min_money" step="100">
                            </div>
                            <div class="form-group">
                                <label>S3 Min Para</label>
                                <input type="number" id="line_freeze-l3_min_money" step="100">
                            </div>
                        </div>
                    </div>
                    <div class="section-title">Pay Esikleri (%)</div>
                    <div class="criteria-section">
                        <div class="switch-container" style="margin-bottom: 12px;">
                            <label class="switch">
                                <input type="checkbox" id="line_freeze-use_share_thresholds">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Pay esiklerini kullan</span>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>S1 Min Pay</label>
                                <input type="number" id="line_freeze-l1_min_share" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>S2 Min Pay</label>
                                <input type="number" id="line_freeze-l2_min_share" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>S3 Min Pay</label>
                                <input type="number" id="line_freeze-l3_min_share" step="0.5">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label>Maksimum Oran Degisimi</label>
                        <div class="input-with-switch">
                            <input type="number" id="line_freeze-max_odds_change" step="0.01">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="line_freeze-use_max_odds_change">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Oran degisimi bu sinirin altinda olmali</span>
                    </div>
                </div>
            </div>

            <!-- Volume Shift -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="volume_shift-status"></span>
                        Volume Shift
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-volume_shift" onclick="recalcAlarmType('volume_shift')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="volume_shift-enabled" onchange="updateStatus('volume_shift')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-volume_shift"></div>
                <div class="card-body">
                    <div class="section-title">Hacim Esikleri</div>
                    <div class="criteria-section">
                        <div class="switch-container" style="margin-bottom: 12px;">
                            <label class="switch">
                                <input type="checkbox" id="volume_shift-use_volume_thresholds">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Hacim esiklerini kullan</span>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>1X2</label>
                                <input type="number" id="volume_shift-volume_1x2" step="100">
                            </div>
                            <div class="form-group">
                                <label>O/U 2.5</label>
                                <input type="number" id="volume_shift-volume_ou25" step="50">
                            </div>
                            <div class="form-group">
                                <label>BTTS</label>
                                <input type="number" id="volume_shift-volume_btts" step="50">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label>Hakimiyet Esigi (%)</label>
                        <div class="input-with-switch">
                            <input type="number" id="volume_shift-dominance_threshold" step="1">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="volume_shift-use_dominance">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Lider sayilmak icin minimum pay %</span>
                    </div>
                </div>
            </div>

            <!-- Reversal Move -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="reversal-status"></span>
                        Reversal Move
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-reversal" onclick="recalcAlarmType('reversal')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="reversal-enabled" onchange="updateStatus('reversal')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-reversal"></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Minimum Geri Donus (%)</label>
                        <div class="input-with-switch">
                            <input type="number" id="reversal-min_retracement" step="5">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="reversal-use_retracement">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Dususun ne kadari geri alinmali</span>
                    </div>
                    <div class="form-group">
                        <label>Onceki Minimum Dusus (%)</label>
                        <div class="input-with-switch">
                            <input type="number" id="reversal-min_drop_before_reversal" step="0.5">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="reversal-use_min_drop">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Reversal oncesi minimum dusus</span>
                    </div>
                </div>
            </div>

            <!-- Big Money -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="big_money-status"></span>
                        Big Money
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-big_money" onclick="recalcAlarmType('big_money')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="big_money-enabled" onchange="updateStatus('big_money')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-big_money"></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>10 Dakikada Minimum Para</label>
                        <div class="input-with-switch">
                            <input type="number" id="big_money-min_money_10min" step="1000">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="big_money-use_10min_threshold">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: 10 dk icinde bu kadar para girmeli</span>
                    </div>
                    <div class="form-group">
                        <label>Tek Seferde Minimum</label>
                        <div class="input-with-switch">
                            <input type="number" id="big_money-one_shot_min" step="1000">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="big_money-use_one_shot">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Tek bir guncelleme bu kadar olmali</span>
                    </div>
                </div>
            </div>

            <!-- Public Surge -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="status-dot" id="public_surge-status"></span>
                        Public Surge
                    </span>
                    <div class="card-header-actions">
                        <button class="btn-recalc" id="recalc-public_surge" onclick="recalcAlarmType('public_surge')">Yeniden Hesapla</button>
                        <label class="switch">
                            <input type="checkbox" id="public_surge-enabled" onchange="updateStatus('public_surge')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="recalc-status" id="recalc-status-public_surge"></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Minimum Para</label>
                        <div class="input-with-switch">
                            <input type="number" id="public_surge-min_money" step="100">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="public_surge-use_min_money">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Minimum para girisi esigi</span>
                    </div>
                    <div class="form-group">
                        <label>Maksimum Oran Degisimi</label>
                        <div class="input-with-switch">
                            <input type="number" id="public_surge-max_odds_change" step="0.01">
                            <label class="switch" title="Bu kriteri kullan">
                                <input type="checkbox" id="public_surge-use_max_odds_change">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <span class="help-text">Aktifse: Oran degisimi bu sinirin altinda</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let config = null;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateStatus(type) {
            const checkbox = document.getElementById(type + '-enabled');
            const dot = document.getElementById(type + '-status');
            if (checkbox.checked) {
                dot.classList.remove('disabled');
                dot.classList.add('enabled');
            } else {
                dot.classList.remove('enabled');
                dot.classList.add('disabled');
            }
        }

        function populateForm(data) {
            const alarmTypes = ['sharp', 'dropping', 'reversal', 'momentum', 'line_freeze', 'volume_shift', 'big_money', 'public_surge'];

            alarmTypes.forEach(type => {
                if (data[type]) {
                    Object.keys(data[type]).forEach(key => {
                        const el = document.getElementById(type + '-' + key);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = data[type][key];
                            } else {
                                el.value = data[type][key];
                            }
                        }
                    });
                    updateStatus(type);
                }
            });
        }

        function collectFormData() {
            const data = {};
            const alarmTypes = ['sharp', 'dropping', 'reversal', 'momentum', 'line_freeze', 'volume_shift', 'big_money', 'public_surge'];

            alarmTypes.forEach(type => {
                data[type] = {};
                const inputs = document.querySelectorAll('[id^="' + type + '-"]');
                inputs.forEach(input => {
                    const key = input.id.replace(type + '-', '');
                    if (input.type === 'checkbox') {
                        data[type][key] = input.checked;
                    } else if (input.type === 'number') {
                        data[type][key] = parseFloat(input.value) || 0;
                    } else {
                        data[type][key] = input.value;
                    }
                });
            });

            return data;
        }

        function updateVersionBadge(version) {
            const badge = document.getElementById('config-version-badge');
            if (badge && version) {
                badge.textContent = 'v' + version;
            }
        }
        
        function loadConfig() {
            fetch('/admin/alarm-config')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                        return;
                    }
                    config = data;
                    populateForm(data);
                    updateVersionBadge(data.config_version);
                    showToast('Yapilandirma yuklendi');
                })
                .catch(err => {
                    showToast('Yapilandirma yukleme hatasi: ' + err, 'error');
                });
        }

        let statusPollInterval = null;
        let currentJobId = null;
        let completionShown = false;
        
        function pollRecalcStatus(targetJobId, onComplete) {
            fetch('/admin/recalc-status')
                .then(res => res.json())
                .then(status => {
                    console.log('[Poll] Status:', status, 'Target job:', targetJobId);
                    
                    if (status.running) {
                        showToast(`Hesaplaniyor... (${status.elapsed_seconds || 0}s, v${status.config_version})`, 'success');
                    } else if (!status.running && !completionShown) {
                        if (statusPollInterval) {
                            clearInterval(statusPollInterval);
                            statusPollInterval = null;
                        }
                        completionShown = true;
                        
                        if (status.error) {
                            showToast('Hata: ' + status.error, 'error');
                        } else {
                            showToast(
                                `Tamamlandi! ${status.deleted} silindi, ${status.detected} olusturuldu (${status.elapsed_seconds || 0}s) - v${status.config_version}`,
                                'success'
                            );
                        }
                        if (onComplete) onComplete();
                    }
                })
                .catch(err => {
                    console.error('Status poll error:', err);
                    if (statusPollInterval) {
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;
                    }
                    if (onComplete) onComplete();
                });
        }
        
        function saveConfig() {
            const data = collectFormData();
            
            console.log('[Admin] Saving config:', JSON.stringify(data, null, 2));
            console.log('[Admin] public_surge.enabled:', data.public_surge?.enabled);
            console.log('[Admin] line_freeze.enabled:', data.line_freeze?.enabled);
            
            const saveBtn = document.querySelector('.btn-primary');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Kaydediliyor...';
            saveBtn.disabled = true;

            fetch('/admin/alarm-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(result => {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    
                    if (result.error) {
                        showToast(result.error, 'error');
                    } else {
                        config = result.config;
                        updateVersionBadge(result.config.config_version);
                        showToast(result.message, 'success');
                    }
                })
                .catch(err => {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    showToast('Kaydetme hatasi: ' + err, 'error');
                });
        }
        
        let typeRecalcPolls = {};
        
        function recalcAlarmType(alarmType) {
            const btn = document.getElementById('recalc-' + alarmType);
            const statusDiv = document.getElementById('recalc-status-' + alarmType);
            
            if (!btn) return;
            
            btn.disabled = true;
            btn.classList.add('running');
            btn.textContent = 'Hesaplaniyor...';
            
            if (statusDiv) {
                statusDiv.classList.add('show');
                statusDiv.textContent = 'Baslatiliyor...';
            }
            
            if (typeRecalcPolls[alarmType]) {
                clearInterval(typeRecalcPolls[alarmType]);
                typeRecalcPolls[alarmType] = null;
            }
            
            fetch('/admin/recalc-alarm/' + alarmType, {
                method: 'POST'
            })
                .then(res => res.json())
                .then(result => {
                    if (result.error) {
                        btn.disabled = false;
                        btn.classList.remove('running');
                        btn.textContent = 'Yeniden Hesapla';
                        if (statusDiv) {
                            statusDiv.textContent = 'Hata: ' + result.error;
                        }
                        showToast('Hata: ' + result.error, 'error');
                    } else {
                        showToast(result.message, 'success');
                        
                        if (result.status === 'started' || result.status === 'already_running') {
                            typeRecalcPolls[alarmType] = setInterval(() => pollTypeRecalcStatus(alarmType), 2000);
                        } else {
                            btn.disabled = false;
                            btn.classList.remove('running');
                            btn.textContent = 'Yeniden Hesapla';
                        }
                    }
                })
                .catch(err => {
                    btn.disabled = false;
                    btn.classList.remove('running');
                    btn.textContent = 'Yeniden Hesapla';
                    if (statusDiv) {
                        statusDiv.textContent = 'Hata: ' + err;
                    }
                    showToast('Hata: ' + err, 'error');
                });
        }
        
        function pollTypeRecalcStatus(alarmType) {
            const btn = document.getElementById('recalc-' + alarmType);
            const statusDiv = document.getElementById('recalc-status-' + alarmType);
            
            fetch('/admin/recalc-alarm-status/' + alarmType)
                .then(res => res.json())
                .then(status => {
                    console.log('[Poll ' + alarmType + ']', status);
                    
                    if (status.running) {
                        if (statusDiv) {
                            statusDiv.textContent = `Hesaplaniyor... (${status.elapsed_seconds || 0}s)`;
                        }
                    } else {
                        if (typeRecalcPolls[alarmType]) {
                            clearInterval(typeRecalcPolls[alarmType]);
                            typeRecalcPolls[alarmType] = null;
                        }
                        
                        if (btn) {
                            btn.disabled = false;
                            btn.classList.remove('running');
                            btn.textContent = 'Yeniden Hesapla';
                        }
                        
                        if (status.error) {
                            if (statusDiv) {
                                statusDiv.textContent = 'Hata: ' + status.error;
                            }
                            showToast(`${alarmType} Hatasi: ${status.error}`, 'error');
                        } else {
                            if (statusDiv) {
                                statusDiv.textContent = `Tamamlandi: ${status.deleted} silindi, ${status.detected} eklendi (${status.elapsed_seconds || 0}s)`;
                            }
                            showToast(`${alarmType}: ${status.deleted} silindi, ${status.detected} eklendi`, 'success');
                            
                            setTimeout(() => {
                                if (statusDiv) statusDiv.classList.remove('show');
                            }, 5000);
                        }
                    }
                })
                .catch(err => {
                    console.error('Type poll error:', err);
                    if (typeRecalcPolls[alarmType]) {
                        clearInterval(typeRecalcPolls[alarmType]);
                        typeRecalcPolls[alarmType] = null;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('running');
                        btn.textContent = 'Yeniden Hesapla';
                    }
                });
        }

        function reloadConfig() {
            fetch('/admin/reload-config', {
                method: 'POST'
            })
                .then(res => res.json())
                .then(result => {
                    if (result.error) {
                        showToast(result.error, 'error');
                    } else {
                        config = result.config;
                        populateForm(result.config);
                        showToast('Yapilandirma dosyadan yuklendi');
                    }
                })
                .catch(err => {
                    showToast('Yukleme hatasi: ' + err, 'error');
                });
        }

        function recalculateAlarms() {
            if (!confirm('Bu islem TUM alarmlari (gecmis dahil) silecek ve yeni yapilandirma ile yeniden hesaplayacak.\n\nBu islem birkac dakika surebilir. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            const btn = document.getElementById('recalc-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Baslatiliyor...';
            btn.disabled = true;
            
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }
            completionShown = false;
            
            fetch('/admin/recalculate-alarms', {
                method: 'POST'
            })
                .then(res => res.json())
                .then(result => {
                    if (result.error) {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        showToast('Hata: ' + result.error, 'error');
                    } else {
                        showToast(result.message, 'success');
                        
                        if (result.status === 'started' || result.status === 'already_running') {
                            const targetJob = result.job_id || (currentJobId + 1);
                            currentJobId = targetJob;
                            console.log('[Admin] Started recalc polling for job:', targetJob);
                            
                            btn.textContent = 'Hesaplaniyor...';
                            statusPollInterval = setInterval(() => pollRecalcStatus(targetJob, () => {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }), 3000);
                        } else {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }
                    }
                })
                .catch(err => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    showToast('Hata: ' + err, 'error');
                });
        }

        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>
