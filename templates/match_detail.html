<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ home }} vs {{ away }} - SmartXFlow</title>
    <link rel="stylesheet" href="/static/css/style.css?v=101">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body class="match-detail-page">
    <header class="header">
        <div class="header-left">
            <a href="/" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="logo">
                <img src="/static/images/smartxflow_logo.png" alt="SmartXFlow" width="32" height="32" style="border-radius: 4px;">
            </div>
            <div class="brand">
                <h1>SmartXFlow</h1>
                <span class="subtitle">Match Detail</span>
            </div>
        </div>
    </header>

    <main class="match-detail-content">
        <div class="match-detail-header">
            <h2 class="match-title">{{ home }} <span class="vs">vs</span> {{ away }}</h2>
            <div class="match-meta" id="matchMeta"></div>
        </div>

        <div class="match-info-card" id="matchInfoCard"></div>

        <div class="chart-section">
            <div class="chart-tabs" id="chartTabs">
                <button class="chart-tab active" data-market="moneyway_1x2">Moneyway 1X2</button>
                <button class="chart-tab" data-market="moneyway_ou25">Moneyway 2.5</button>
                <button class="chart-tab" data-market="moneyway_btts">Moneyway BTTS</button>
                <button class="chart-tab" data-market="dropping_1x2">Drop 1X2</button>
                <button class="chart-tab" data-market="dropping_ou25">Drop 2.5</button>
                <button class="chart-tab" data-market="dropping_btts">Drop BTTS</button>
            </div>
            
            <div class="chart-legend-filters" id="chartLegendFilters"></div>
            
            <div class="chart-wrapper-full">
                <canvas id="oddsChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        const matchHome = "{{ home }}";
        const matchAway = "{{ away }}";
        let currentMarket = 'moneyway_1x2';
        let oddsChart = null;
        let matchData = null;
        let modalOddsData = null;
        let chartVisibleSeries = {};
        let chartTimeRange = '5min';
        let chartViewMode = 'percent';
        let currentChartHistoryData = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadMatchData();
            setupChartTabs();
        });

        async function loadMatchData() {
            try {
                const response = await fetch('/api/match/details?home=' + encodeURIComponent(matchHome) + '&away=' + encodeURIComponent(matchAway));
                const data = await response.json();
                if (data.success && data.match) {
                    matchData = data.match;
                    document.getElementById('matchMeta').innerHTML = '<span class="match-league">' + (matchData.league || '') + '</span><span class="match-date">' + (matchData.date || '') + '</span>';
                    loadMatchHistory(currentMarket);
                    renderMatchInfoCard();
                }
            } catch (error) { console.error('[Match Detail] Error:', error); }
        }

        function setupChartTabs() {
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentMarket = this.dataset.market;
                    loadMatchHistory(currentMarket);
                    renderMatchInfoCard();
                });
            });
        }

        async function loadMatchHistory(market) {
            try {
                const response = await fetch('/api/match/history?home=' + encodeURIComponent(matchHome) + '&away=' + encodeURIComponent(matchAway) + '&market=' + market);
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    modalOddsData = data.history[data.history.length - 1];
                    currentChartHistoryData = data.history;
                    renderChart(data.history, market);
                    renderChartLegendFilters(market);
                }
            } catch (error) { console.error('[Match History] Error:', error); }
        }

        function parseAmount(val) {
            if (!val) return 0;
            let str = String(val).replace(/[£,\s]/g, '');
            let multiplier = 1;
            if (str.includes('M')) { multiplier = 1000000; str = str.replace('M', ''); }
            if (str.includes('K')) { multiplier = 1000; str = str.replace('K', ''); }
            return parseFloat(str) * multiplier || 0;
        }
        
        function getPctClass(pct) {
            const val = parseFloat(pct) || 0;
            if (val >= 80) return 'pct-max';
            if (val >= 60) return 'pct-high';
            if (val >= 20) return 'pct-mid';
            return 'pct-low';
        }

        function renderMatchInfoCard() {
            const card = document.getElementById('matchInfoCard');
            if (!matchData || !modalOddsData) return;
            let totalVol = 0;
            if (currentMarket.includes('1x2')) {
                totalVol = parseAmount(modalOddsData.Amt1) + parseAmount(modalOddsData.AmtX) + parseAmount(modalOddsData.Amt2);
            } else if (currentMarket.includes('ou25')) {
                totalVol = parseAmount(modalOddsData.AmtOver) + parseAmount(modalOddsData.AmtUnder);
            } else if (currentMarket.includes('btts')) {
                totalVol = parseAmount(modalOddsData.AmtYes) + parseAmount(modalOddsData.AmtNo);
            }
            let vol = totalVol > 0 ? Math.round(totalVol).toLocaleString('en-GB') : '0';
            let html = '<div class="info-row total-volume"><span class="volume-label">TOTAL VOLUME</span><span class="volume-value">£' + vol + '</span></div>';
            if (currentMarket.includes('1x2')) {
                html += '<div class="selections-grid"><div class="selection-card"><div class="selection-label">' + matchHome + '</div><div class="selection-odds">' + (modalOddsData.Odds1||'-') + '</div><div class="selection-pct ' + getPctClass(modalOddsData.Pct1) + '">' + (modalOddsData.Pct1||'-') + '%</div>' + (modalOddsData.Amt1?'<div class="selection-amt">£' + parseInt(modalOddsData.Amt1).toLocaleString('en-GB') + '</div>':'') + '</div><div class="selection-card"><div class="selection-label">Draw</div><div class="selection-odds">' + (modalOddsData.OddsX||'-') + '</div><div class="selection-pct ' + getPctClass(modalOddsData.PctX) + '">' + (modalOddsData.PctX||'-') + '%</div>' + (modalOddsData.AmtX?'<div class="selection-amt">£' + parseInt(modalOddsData.AmtX).toLocaleString('en-GB') + '</div>':'') + '</div><div class="selection-card"><div class="selection-label">' + matchAway + '</div><div class="selection-odds">' + (modalOddsData.Odds2||'-') + '</div><div class="selection-pct ' + getPctClass(modalOddsData.Pct2) + '">' + (modalOddsData.Pct2||'-') + '%</div>' + (modalOddsData.Amt2?'<div class="selection-amt">£' + parseInt(modalOddsData.Amt2).toLocaleString('en-GB') + '</div>':'') + '</div></div>';
            }
            card.innerHTML = html;
        }

        function renderChartLegendFilters(market) {
            const container = document.getElementById('chartLegendFilters');
            if (!container) return;
            
            const legendLabels = {
                'moneyway_1x2': [{key:'1',label:'1',color:'#3b82f6'},{key:'X',label:'X',color:'#22c55e'},{key:'2',label:'2',color:'#eab308'}],
                'moneyway_ou25': [{key:'Under',label:'Under 2.5',color:'#3b82f6'},{key:'Over',label:'Over 2.5',color:'#22c55e'}],
                'moneyway_btts': [{key:'Yes',label:'BTTS Yes',color:'#22c55e'},{key:'No',label:'BTTS No',color:'#ef4444'}],
                'dropping_1x2': [{key:'1',label:'1',color:'#3b82f6'},{key:'X',label:'X',color:'#22c55e'},{key:'2',label:'2',color:'#eab308'}],
                'dropping_ou25': [{key:'Under',label:'Under 2.5',color:'#3b82f6'},{key:'Over',label:'Over 2.5',color:'#22c55e'}],
                'dropping_btts': [{key:'Yes',label:'BTTS Yes',color:'#22c55e'},{key:'No',label:'BTTS No',color:'#ef4444'}]
            };
            
            const items = legendLabels[market] || [];
            const timeRanges = [{key:'5min',label:'5 dk'},{key:'10min',label:'10 dk'},{key:'30min',label:'30 dk'},{key:'1hour',label:'1 saat'},{key:'6hour',label:'6 saat'},{key:'12hour',label:'12 saat'},{key:'1day',label:'1 gün'}];
            
            const seriesButtons = items.map(item => {
                const stateKey = market + '_' + item.key;
                const isActive = chartVisibleSeries[stateKey] !== false;
                return '<button class="chart-legend-btn ' + (isActive?'active':'inactive') + '" style="--legend-color:' + item.color + ';" onclick="toggleChartSeries(\'' + market + '\',\'' + item.key + '\',this)"><span class="legend-color-dot"></span><span>' + item.label + '</span></button>';
            }).join('');
            
            const timeButtons = timeRanges.map(tr => '<button class="chart-time-btn ' + (chartTimeRange===tr.key?'active':'') + '" data-range="' + tr.key + '" onclick="setChartTimeRange(\'' + tr.key + '\')">' + tr.label + '</button>').join('');
            
            const isMoneyway = market.startsWith('moneyway');
            const viewModeButtons = isMoneyway ? '<div class="chart-filter-group view-mode-filters"><button class="chart-view-btn ' + (chartViewMode==='percent'?'active':'') + '" onclick="setChartViewMode(\'percent\')">% Yuzde</button><button class="chart-view-btn ' + (chartViewMode==='money'?'active':'') + '" onclick="setChartViewMode(\'money\')">£ Para</button></div><div class="chart-filter-divider"></div>' : '';
            
            container.innerHTML = viewModeButtons + '<div class="chart-filter-group series-filters">' + seriesButtons + '</div><div class="chart-filter-divider"></div><div class="chart-filter-group time-filters">' + timeButtons + '</div><div class="chart-filter-divider"></div><div class="chart-export-btns"><button class="chart-export-btn" onclick="exportChartPNG()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>PNG</button><button class="chart-export-btn" onclick="exportChartCSV()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>CSV</button></div>';
        }

        function toggleChartSeries(market, key, btn) {
            const stateKey = market + '_' + key;
            chartVisibleSeries[stateKey] = chartVisibleSeries[stateKey] === false ? true : false;
            btn.classList.toggle('active');
            btn.classList.toggle('inactive');
            renderChart(currentChartHistoryData, market);
        }

        function setChartTimeRange(range) {
            chartTimeRange = range;
            document.querySelectorAll('.chart-time-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.chart-time-btn[data-range="' + range + '"]').classList.add('active');
            renderChart(currentChartHistoryData, currentMarket);
        }

        function setChartViewMode(mode) {
            chartViewMode = mode;
            document.querySelectorAll('.chart-view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.chart-view-btn[onclick*="' + mode + '"]').classList.add('active');
            renderChart(currentChartHistoryData, currentMarket);
        }

        function getTimeRangeMs(range) {
            const ranges = {'5min':300000,'10min':600000,'30min':1800000,'1hour':3600000,'6hour':21600000,'12hour':43200000,'1day':86400000};
            return ranges[range] || 300000;
        }

        function renderChart(history, market) {
            if (oddsChart) oddsChart.destroy();
            const canvas = document.getElementById('oddsChart');
            const ctx = canvas.getContext('2d');
            
            function createGradient(hex) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.35)`);
                gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0.02)`);
                return gradient;
            }
            
            const bucketMs = getTimeRangeMs(chartTimeRange);
            const bucketedData = {};
            history.forEach(h => {
                const ts = new Date(h.ScrapedAt).getTime();
                const bucket = Math.floor(ts / bucketMs) * bucketMs;
                if (!bucketedData[bucket]) bucketedData[bucket] = h;
            });
            const bucketedHistory = Object.keys(bucketedData).sort((a,b)=>a-b).map(k => bucketedData[k]);
            
            const labels = bucketedHistory.map(h => new Date(h.ScrapedAt).toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'}));
            let datasets = [];
            
            const isMoneyway = market.startsWith('moneyway');
            const usePct = chartViewMode === 'percent';
            
            if (market.includes('1x2')) {
                const show1 = chartVisibleSeries[market+'_1'] !== false;
                const showX = chartVisibleSeries[market+'_X'] !== false;
                const show2 = chartVisibleSeries[market+'_2'] !== false;
                if (show1) datasets.push({label:'1',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.Pct1)||0:parseFloat(h.Amt1)||0):parseFloat(h.Odds1)||0),borderColor:'#3b82f6',backgroundColor:createGradient('#3b82f6'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
                if (showX) datasets.push({label:'X',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.PctX)||0:parseFloat(h.AmtX)||0):parseFloat(h.OddsX)||0),borderColor:'#22c55e',backgroundColor:createGradient('#22c55e'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
                if (show2) datasets.push({label:'2',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.Pct2)||0:parseFloat(h.Amt2)||0):parseFloat(h.Odds2)||0),borderColor:'#eab308',backgroundColor:createGradient('#eab308'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
            } else if (market.includes('ou25')) {
                const showUnder = chartVisibleSeries[market+'_Under'] !== false;
                const showOver = chartVisibleSeries[market+'_Over'] !== false;
                if (showUnder) datasets.push({label:'Under 2.5',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.PctUnder)||0:parseFloat(h.AmtUnder)||0):parseFloat(h.Under)||0),borderColor:'#3b82f6',backgroundColor:createGradient('#3b82f6'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
                if (showOver) datasets.push({label:'Over 2.5',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.PctOver)||0:parseFloat(h.AmtOver)||0):parseFloat(h.Over)||0),borderColor:'#22c55e',backgroundColor:createGradient('#22c55e'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
            } else {
                const showYes = chartVisibleSeries[market+'_Yes'] !== false;
                const showNo = chartVisibleSeries[market+'_No'] !== false;
                if (showYes) datasets.push({label:'BTTS Yes',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.PctYes)||0:parseFloat(h.AmtYes)||0):parseFloat(h.OddsYes)||0),borderColor:'#22c55e',backgroundColor:createGradient('#22c55e'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
                if (showNo) datasets.push({label:'BTTS No',data:bucketedHistory.map(h=>isMoneyway?(usePct?parseFloat(h.PctNo)||0:parseFloat(h.AmtNo)||0):parseFloat(h.OddsNo)||0),borderColor:'#ef4444',backgroundColor:createGradient('#ef4444'),tension:0.4,pointRadius:0,pointHoverRadius:4,borderWidth:2,fill:true});
            }
            
            oddsChart = new Chart(canvas, {
                type:'line',
                data:{labels,datasets},
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    animation:false,
                    interaction:{
                        mode:'index',
                        intersect:false
                    },
                    plugins:{
                        legend:{display:false},
                        tooltip:{
                            enabled:true,
                            backgroundColor:'#020617EE',
                            titleColor:'#6E7681',
                            bodyColor:'#C9D1D9',
                            borderColor:'#374151',
                            borderWidth:1,
                            cornerRadius:10,
                            padding:{top:8,bottom:8,left:10,right:10},
                            titleFont:{size:12,weight:'400',family:"'Inter', sans-serif"},
                            bodyFont:{size:13,weight:'500',family:"'Inter', sans-serif"},
                            bodySpacing:4,
                            boxPadding:4,
                            usePointStyle:true,
                            displayColors:true,
                            callbacks:{
                                title:function(ctx){
                                    const idx = ctx[0].dataIndex;
                                    const h = bucketedHistory[idx];
                                    if(h && h.ScrapedAt){
                                        const d = new Date(h.ScrapedAt);
                                        return d.toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit'}) + ' • ' + d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
                                    }
                                    return ctx[0].label;
                                },
                                label:function(ctx){
                                    const val = ctx.parsed.y;
                                    const label = ctx.dataset.label;
                                    const prefix = isMoneyway && !usePct ? '£' : '';
                                    const suffix = isMoneyway && usePct ? '%' : '';
                                    return label + ': ' + prefix + val.toLocaleString('en-GB') + suffix;
                                }
                            }
                        },
                        zoom:{
                            pan:{enabled:true,mode:'x',modifierKey:'shift'},
                            zoom:{
                                wheel:{enabled:true},
                                pinch:{enabled:true},
                                drag:{enabled:true,backgroundColor:'rgba(76,139,245,0.15)',borderColor:'#4C8BF5',borderWidth:1},
                                mode:'x'
                            },
                            limits:{x:{min:'original',max:'original'}}
                        }
                    },
                    scales:{
                        x:{grid:{color:'rgba(148, 163, 184, 0.13)'},border:{display:false},ticks:{color:'#8B949E',font:{size:11,family:"'Inter', sans-serif"},maxRotation:45,maxTicksLimit:12}},
                        y:{grid:{color:'rgba(148, 163, 184, 0.13)'},border:{display:false},ticks:{color:'#8B949E',font:{size:11,family:"'Inter', sans-serif"},callback:function(value){if(isMoneyway && !usePct){return '£'+value.toLocaleString('en-GB');}else if(isMoneyway && usePct){return value+'%';}return value;}}}
                    },
                    elements:{point:{radius:0,hoverRadius:5,borderWidth:2},line:{borderWidth:2}}
                }
            });
            
            const chartContainer = canvas.parentElement;
            let resetBtn = chartContainer.querySelector('.chart-zoom-reset');
            if (!resetBtn) {
                resetBtn = document.createElement('button');
                resetBtn.className = 'chart-zoom-reset';
                resetBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> Reset Zoom';
                resetBtn.onclick = function() { oddsChart.resetZoom(); };
                chartContainer.style.position = 'relative';
                chartContainer.appendChild(resetBtn);
            } else {
                resetBtn.onclick = function() { oddsChart.resetZoom(); };
            }
        }

        async function exportChartPNG() {
            const content = document.querySelector('.match-detail-content');
            try {
                const canvas = await html2canvas(content, {backgroundColor:'#0d1117',scale:2});
                const link = document.createElement('a');
                link.download = matchHome + '_vs_' + matchAway + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) { console.error('[PNG Export] Error:', e); }
        }

        function exportChartCSV() {
            if (!currentChartHistoryData || currentChartHistoryData.length === 0) return;
            const headers = Object.keys(currentChartHistoryData[0]);
            let csv = headers.join(',') + '\n';
            currentChartHistoryData.forEach(row => {
                csv += headers.map(h => '"' + (row[h] || '') + '"').join(',') + '\n';
            });
            const blob = new Blob([csv], {type:'text/csv'});
            const link = document.createElement('a');
            link.download = matchHome + '_vs_' + matchAway + '_' + currentMarket + '.csv';
            link.href = URL.createObjectURL(blob);
            link.click();
        }
    </script>
</body>
</html>
