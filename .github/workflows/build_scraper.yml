name: Build Standalone Scraper EXE

on:
  push:
    branches: [ main ]
    paths:
      - 'scraper_standalone/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper_standalone/requirements.txt
          pip install pyinstaller==6.3.0
        shell: cmd

      - name: Create config with secrets
        run: |
          python -c "import json,re; url='${{ secrets.SUPABASE_URL }}'; key='${{ secrets.SUPABASE_ANON_KEY }}'; m=re.search(r'([a-z]{20,})',url); correct_url=f'https://{m.group(1)}.supabase.co' if m else url; print(f'Corrected URL: {correct_url}'); json.dump({'SUPABASE_URL':correct_url,'SUPABASE_ANON_KEY':key},open('scraper_standalone/config.json','w'),indent=2)"
          echo "=== config.json content ==="
          cat scraper_standalone/config.json
        shell: bash

      - name: Build Scraper EXE
        run: |
          cd scraper_standalone
          python -c "import certifi; print(certifi.where())" > certifi_path.txt
          set /p CERTIFI_PATH=<certifi_path.txt
          pyinstaller --onefile --console --name "SmartXFlowAlarmV1.01Scraper" --icon=NONE --add-data "config.json;." --add-data "%CERTIFI_PATH%;certifi" --collect-data certifi standalone_scraper.py
        shell: cmd

      - name: Prepare dist folder
        run: |
          copy scraper_standalone\config.json scraper_standalone\dist\config.json
          echo # SmartXFlowScraper - Calistirma Talimati > scraper_standalone\dist\README.txt
          echo. >> scraper_standalone\dist\README.txt
          echo Cift tiklayarak EXE'yi calistir. Konsol penceresi acilacak. >> scraper_standalone\dist\README.txt
          echo Pencereyi minimize edebilirsin ama kapatma. >> scraper_standalone\dist\README.txt
          echo Scraper her 10 dakikada bir calisir. >> scraper_standalone\dist\README.txt
        shell: cmd

      - name: List output files
        run: |
          echo "=== dist folder contents ==="
          dir scraper_standalone\dist
          echo "=== Full path check ==="
          dir /s /b scraper_standalone\dist\*.exe
        shell: cmd

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: scraper-v1.01-${{ github.run_number }}
          name: SmartXFlow Scraper v1.01 Build ${{ github.run_number }}
          files: |
            scraper_standalone/dist/*.exe
            scraper_standalone/dist/config.json
            scraper_standalone/dist/README.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
