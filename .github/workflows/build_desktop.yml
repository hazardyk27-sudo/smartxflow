name: Build SmartXFlow Desktop App

on:
  push:
    branches: [ main ]
    paths:
      - 'desktop_app.py'
      - 'app.py'
      - 'static/**'
      - 'templates/**'
      - 'core/**'
      - 'services/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask==3.0.0 httpx supabase==2.3.4 requests==2.31.0 beautifulsoup4==4.12.3 lxml==5.1.0 pytz pywebview==5.0.5
          pip install pyinstaller==6.3.0
        shell: cmd

      - name: Create embedded_credentials.py with secrets
        run: |
          python -c "
          with open('services/embedded_credentials.py', 'w') as f:
              f.write('SUPABASE_URL = \"${{ secrets.SUPABASE_URL }}\"\\n')
              f.write('SUPABASE_KEY = \"${{ secrets.SUPABASE_ANON_KEY }}\"\\n')
          "
        shell: bash

      - name: Create config.json with secrets
        run: |
          python -c "
          import json
          data = {'SUPABASE_URL': '${{ secrets.SUPABASE_URL }}', 'SUPABASE_ANON_KEY': '${{ secrets.SUPABASE_ANON_KEY }}'}
          with open('config.json', 'w') as f:
              json.dump(data, f, indent=2)
          "
        shell: bash

      - name: Create BUILD_INFO.txt
        run: |
          echo SmartXFlow Desktop V1.01 > BUILD_INFO.txt
          echo Build Date: %date% %time% >> BUILD_INFO.txt
          echo Commit: ${{ github.sha }} >> BUILD_INFO.txt
          echo Branch: ${{ github.ref_name }} >> BUILD_INFO.txt
        shell: cmd

      - name: Build Desktop App EXE
        run: |
          pyinstaller --onefile --windowed --name SmartXFlowDesktop ^
            --icon "smartxflow.ico" ^
            --add-data "app.py;." ^
            --add-data "config.json;." ^
            --add-data "BUILD_INFO.txt;." ^
            --add-data "templates;templates" ^
            --add-data "static;static" ^
            --add-data "core;core" ^
            --add-data "services;services" ^
            --hidden-import flask ^
            --hidden-import jinja2 ^
            --hidden-import supabase ^
            --hidden-import httpx ^
            --hidden-import pywebview ^
            --hidden-import webview ^
            --hidden-import clr ^
            desktop_app.py
        shell: cmd

      - name: Copy files to dist
        run: |
          copy config.json dist\config.json
          copy BUILD_INFO.txt dist\BUILD_INFO.txt
        shell: cmd

      - name: List output
        run: dir dist
        shell: cmd

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: desktop-v1.01-${{ github.run_number }}
          name: SmartXFlow Desktop v1.01 Build ${{ github.run_number }}
          files: |
            dist/SmartXFlowDesktop.exe
            dist/config.json
            dist/BUILD_INFO.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
